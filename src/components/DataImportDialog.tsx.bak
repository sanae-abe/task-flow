import { useState, useCallback, memo } from 'react';
import { Box, Button, Text, Spinner, Flash, Select } from '@primer/react';
import { FileIcon, UploadIcon } from '@primer/octicons-react';

import { useKanban } from '../contexts/KanbanContext';
import { validateImportData, readFileAsText } from '../utils/dataExport';
import { useDataImportDropZone } from '../hooks/useDataImportDropZone';

import UnifiedDialog from './shared/Dialog/UnifiedDialog';

/**
 * データインポート用のダイアログコンポーネント
 * JSONファイルからカンバンボードデータをインポートする機能を提供
 */
interface DataImportDialogProps {
  /** ダイアログの表示状態 */
  isOpen: boolean;
  /** ダイアログを閉じる際のコールバック */
  onClose: () => void;
}

type ImportMode = 'merge' | 'replace';
type MessageType = { type: 'success' | 'error'; text: string };

const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

export const DataImportDialog = memo<DataImportDialogProps>(({ isOpen, onClose }) => {
  const { importBoards } = useKanban();
  const [isLoading, setIsLoading] = useState(false);
  const [message, setMessage] = useState<MessageType | null>(null);
  const [importMode, setImportMode] = useState<ImportMode>('merge');
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  const processFile = useCallback(async (file: File) => {
    setIsLoading(true);
    setMessage(null);

    try {
      const fileContent = await readFileAsText(file);
      const parsedData = JSON.parse(fileContent);
      const validatedData = validateImportData(parsedData);

      const replaceAll = importMode === 'replace';
      importBoards(validatedData.boards, replaceAll);

      const importedCount = validatedData.boards.length;
      const modeText = replaceAll ? '置換' : '追加';
      setMessage({
        type: 'success',
        text: `${importedCount}個のボードを${modeText}しました`
      });

      // 成功後に少し待ってからダイアログを閉じる
      setTimeout(() => {
        onClose();
        setMessage(null);
        setSelectedFile(null);
      }, 1500);

    } catch (error) {
      let errorMessage = 'インポートに失敗しました';
      if (error instanceof SyntaxError) {
        errorMessage = 'JSONファイルの形式が正しくありません';
      } else if (error instanceof Error) {
        errorMessage = error.message;
      }
      setMessage({ type: 'error', text: errorMessage });
    } finally {
      setIsLoading(false);
    }
  }, [importMode, importBoards, onClose]);

  const dropZoneProps = useDataImportDropZone({
    maxFileSize: MAX_FILE_SIZE,
    onFileSelected: useCallback((file: File) => {
      setSelectedFile(file);
      setMessage(null);
    }, []),
    disabled: isLoading
  });

  const handleDialogClose = useCallback(() => {
    if (!isLoading) {
      onClose();
      setMessage(null);
      setSelectedFile(null);
    }
  }, [isLoading, onClose]);

  const handleModeChange = useCallback((mode: ImportMode) => {
    setImportMode(mode);
  }, []);

  const handleUpload = useCallback(() => {
    if (selectedFile) {
      processFile(selectedFile);
    }
  }, [selectedFile, processFile]);

  return (
    <CommonDialogCompat
      isOpen={isOpen}
      title="データインポート"
      onClose={handleDialogClose}
      size="small"
      ariaLabelledBy="import-dialog-title"
      actions={
        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
          {/* メッセージ表示 */}
          {message && (
            <Flash variant={message.type === 'error' ? 'danger' : 'success'}>
              {message.text}
            </Flash>
          )}
          
          {/* アクションボタン */}
          <Box sx={{ display: 'flex', justifyContent: 'flex-end', gap: 2 }}>
            <Button onClick={handleDialogClose} disabled={isLoading}>
              キャンセル
            </Button>
            {!selectedFile ? (
              <Button
                variant="primary"
                onClick={dropZoneProps.handleFileSelect}
                disabled={isLoading}
                leadingVisual={FileIcon}
                sx={{ color: 'fg.onEmphasis !important' }}
              >
                JSONファイルを選択
              </Button>
            ) : (
              <Button
                variant="primary"
                onClick={handleUpload}
                disabled={isLoading}
                leadingVisual={UploadIcon}
                sx={{ color: 'fg.onEmphasis !important' }}
              >
                {isLoading ? 'インポート中...' : 'インポート実行'}
              </Button>
            )}
          </Box>
        </Box>
      }
    >
      {/* インポートモード選択 */}
      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1, mb: 3 }}>
        <Text sx={{ fontSize: 1, fontWeight: '600', color: 'fg.muted' }}>インポートモード</Text>
        <Select
          value={importMode}
          onChange={(e) => handleModeChange(e.target.value as ImportMode)}
          disabled={isLoading}
        >
          <Select.Option value="merge">既存データに追加</Select.Option>
          <Select.Option value="replace">既存データを置換</Select.Option>
        </Select>
      </Box>

      {/* 選択されたファイル表示 */}
      {selectedFile && (
        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1, mb: 3, p: 2, bg: 'canvas.subtle', borderRadius: 2 }}>
          <Text sx={{ fontSize: 1, fontWeight: '600', color: 'fg.default' }}>選択されたファイル</Text>
          <Text sx={{ fontSize: 1, color: 'fg.muted' }}>{selectedFile.name}</Text>
          <Text sx={{ fontSize: 0, color: 'fg.muted' }}>
            サイズ: {(selectedFile.size / 1024).toFixed(1)} KB
          </Text>
        </Box>
      )}

      {/* ローディング表示 */}
      {isLoading && (
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 3 }}>
          <Spinner size="small" />
          <Text sx={{ fontSize: 1 }}>処理中...</Text>
        </Box>
      )}
      
      {/* 隠しファイル入力 */}
      <input
        ref={dropZoneProps.fileInputRef}
        type="file"
        accept=".json,application/json"
        onChange={dropZoneProps.handleFileInputChange}
        style={{ display: 'none' }}
        disabled={isLoading}
      />
    </CommonDialogCompat>
  );
});

DataImportDialog.displayName = 'DataImportDialog';